# 解析规则技术参考文档

本文档详细介绍了所有支持的解析规则、属性提取方法和管道函数。这是一份技术参考文档，适合已经掌握基础书源编写的用户阅读。如果你是新手，建议先阅读[书源编写教程](book_source_tutorial.md)。

## 解析协议

### XPath
XPath 是默认的解析协议，用于解析 HTML 内容。使用时可以省略 `xpath:` 前缀。

**基本语法：**
```
//标签名[@属性='值']  # 查找特定标签
//标签名[位置]       # 按位置选择元素
/子元素             # 选择直接子元素
//后代元素          # 选择所有后代元素
```

**常用函数：**
```
position()         # 获取位置
contains()         # 包含判断
text()             # 获取文本节点
```

### JSONPath
JSONPath 规则以 `$` 开头，用于解析 JSON 内容。

**基本语法：**
```
$.key              # 访问对象属性
$[index]           # 访问数组元素
$..key             # 递归查找属性
$[?(@.key='值')]   # 条件过滤
```

## 属性提取

在规则后面添加 `@属性名` 可以提取对应的属性值。

### 标准 HTML 属性

可以提取任何标准的 HTML 属性值（除了 class 和 id）：

```
@href      # 提取链接地址
@src       # 提取图片地址
@value     # 提取输入框的值
@content   # 提取 meta 标签的内容
@title     # 提取 title 属性
@alt       # 提取图片替代文本
```

### 特殊属性

除了标准 HTML 属性外，还支持以下特殊属性：

```
@text       # 提取元素的纯文本内容（不包含 HTML 标签）
@html       # 提取元素的原始 HTML 内容（包含 HTML 标签）
@outerHtml  # 提取元素及其 HTML 内容（包含元素本身的标签）
```

## 管道函数

使用 `|` 符号可以连接多个规则或函数，形成处理管道。所有函数规则都以 `dart.` 开头。

### 文本处理函数

#### trim()
去除字符串首尾的空白字符。

```
//div[@class='content']/text()|dart.trim()
```

#### substring(start, end?)
截取字符串的一部分。

参数：
- start: 开始位置的索引（必需）
- end: 结束位置的索引（可选）

```
//div/text()|dart.substring(0,10)  # 截取前10个字符
//div/text()|dart.substring(5)     # 从第5个字符开始截取到末尾
```

### 替换函数

#### replace(from, to)
替换字符串中的所有匹配项。

参数：
- from: 要替换的文本（必需）
- to: 替换后的文本（必需）

```
//div/text()|dart.replace(旧文本,新文本)
//div/text()|dart.replace(\n,)  # 删除所有换行符
```

#### replaceFirst(from, to)
替换字符串中的第一个匹配项。

参数：
- from: 要替换的文本（必需）
- to: 替换后的文本（必需）

```
//div/text()|dart.replaceFirst(第一章,第1章)
```

#### replaceRegExp(pattern, replacement)
使用正则表达式替换字符串中的所有匹配项。

参数：
- pattern: 正则表达式模式（必需）
- replacement: 替换的文本（必需）

```
//div/text()|dart.replaceRegExp(\s+,)  # 将连续的空白字符替换为单个空格
//div/text()|dart.replaceRegExp([\[\]【】],)  # 删除所有中英文方括号
```

### 匹配和格式化函数

#### match(pattern)
使用正则表达式匹配字符串，返回第一个匹配项。

参数：
- pattern: 正则表达式模式（必需）

```
//div/text()|dart.match(\d+)  # 匹配第一个数字序列
//div/text()|dart.match(第.*?章)  # 匹配章节标题
```

#### interpolate(template)
将字符串插入到模板中，使用 {{string}} 作为占位符。

参数：
- template: 包含 {{string}} 占位符的模板字符串（必需）

```
//div/text()|dart.interpolate(章节：{{string}})  # 添加前缀
//div/text()|dart.interpolate({{string}}完)  # 添加后缀
```

## 最佳实践

1. **选择器优化**
   - 使用相对路径而不是绝对路径
   - 避免过于复杂的选择器
   - 优先使用唯一标识符

2. **属性提取**
   - 优先使用 @text 而不是 text() 函数
   - 需要 HTML 内容时才使用 @html 或 @outerHtml

3. **管道函数使用**
   - 合理组合多个函数
   - 按照数据处理的逻辑顺序排列函数

4. **调试技巧**
   - 分步测试复杂的规则
   - 使用简单规则验证选择器
   - 注意检查特殊字符和空白字符

## 常见问题解决

1. **规则无法匹配**
   - 检查网页源码中的实际结构
   - 验证选择器语法是否正确
   - 确认是否需要处理动态加载的内容

2. **提取结果不完整**
   - 检查是否漏掉了某些条件
   - 确认选择器是否过于严格
   - 验证是否需要合并多个结果

3. **特殊情况处理**
   - 使用正则表达式处理复杂格式
   - 合理使用替换函数处理异常
   - 添加适当的错误处理机制

## 注意事项

1. XPath 是默认的解析协议，可以省略 `xpath:` 前缀
2. JSONPath 必须以 `$` 开头
3. 不支持提取 `class` 和 `id` 属性
4. 函数规则必须以 `dart.` 开头
5. 多个规则可以使用 `|` 连接形成处理管道